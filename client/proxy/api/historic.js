'use strict';

const fs = require('fs');


const DECADES = [1860, 1890, 1900, 1920, 1950, 1960, 1980];

const OVERLAPPING_COUNTIES = {
  "features": [
    {
      "geometry": {
        "type": "MultiPolygon",
        "coordinates": [
          [
            [
              [
                355000,
                585000
              ],
              [
                355000,
                580000
              ],
              [
                350000,
                580000
              ],
              [
                350000,
                575000
              ],
              [
                350000,
                570000
              ],
              [
                350000,
                565000
              ],
              [
                345000,
                565000
              ],
              [
                345000,
                560000
              ],
              [
                340000,
                560000
              ],
              [
                335000,
                560000
              ],
              [
                330000,
                560000
              ],
              [
                325000,
                560000
              ],
              [
                320000,
                560000
              ],
              [
                315000,
                560000
              ],
              [
                315000,
                555000
              ],
              [
                315000,
                550000
              ],
              [
                310000,
                550000
              ],
              [
                305000,
                550000
              ],
              [
                300000,
                550000
              ],
              [
                295000,
                550000
              ],
              [
                290000,
                550000
              ],
              [
                290000,
                555000
              ],
              [
                290000,
                560000
              ],
              [
                290000,
                565000
              ],
              [
                290000,
                570000
              ],
              [
                290000,
                575000
              ],
              [
                285000,
                575000
              ],
              [
                280000,
                575000
              ],
              [
                275000,
                575000
              ],
              [
                270000,
                575000
              ],
              [
                270000,
                580000
              ],
              [
                265000,
                580000
              ],
              [
                260000,
                580000
              ],
              [
                260000,
                585000
              ],
              [
                260000,
                590000
              ],
              [
                260000,
                595000
              ],
              [
                260000,
                600000
              ],
              [
                260000,
                605000
              ],
              [
                260000,
                610000
              ],
              [
                260000,
                615000
              ],
              [
                260000,
                620000
              ],
              [
                260000,
                625000
              ],
              [
                265000,
                625000
              ],
              [
                270000,
                625000
              ],
              [
                275000,
                625000
              ],
              [
                280000,
                625000
              ],
              [
                285000,
                625000
              ],
              [
                290000,
                625000
              ],
              [
                295000,
                625000
              ],
              [
                295000,
                620000
              ],
              [
                295000,
                615000
              ],
              [
                300000,
                615000
              ],
              [
                305000,
                615000
              ],
              [
                310000,
                615000
              ],
              [
                310000,
                620000
              ],
              [
                310000,
                625000
              ],
              [
                315000,
                625000
              ],
              [
                320000,
                625000
              ],
              [
                325000,
                625000
              ],
              [
                325000,
                620000
              ],
              [
                325000,
                615000
              ],
              [
                330000,
                615000
              ],
              [
                335000,
                615000
              ],
              [
                335000,
                610000
              ],
              [
                340000,
                610000
              ],
              [
                345000,
                610000
              ],
              [
                345000,
                605000
              ],
              [
                350000,
                605000
              ],
              [
                355000,
                605000
              ],
              [
                355000,
                600000
              ],
              [
                355000,
                595000
              ],
              [
                355000,
                590000
              ],
              [
                355000,
                585000
              ]
            ]
          ]
        ]
      },
      "type": "Feature",
      "properties": {
        "code": "dumf",
        "county": "Dumfriesshire"
      }
    },
    {
      "geometry": {
        "type": "MultiPolygon",
        "coordinates": [
          [
            [
              [
                370000,
                595000
              ],
              [
                370000,
                590000
              ],
              [
                370000,
                585000
              ],
              [
                365000,
                585000
              ],
              [
                365000,
                580000
              ],
              [
                360000,
                580000
              ],
              [
                360000,
                575000
              ],
              [
                355000,
                575000
              ],
              [
                350000,
                575000
              ],
              [
                345000,
                575000
              ],
              [
                340000,
                575000
              ],
              [
                335000,
                575000
              ],
              [
                330000,
                575000
              ],
              [
                330000,
                580000
              ],
              [
                330000,
                585000
              ],
              [
                330000,
                590000
              ],
              [
                330000,
                595000
              ],
              [
                325000,
                595000
              ],
              [
                320000,
                595000
              ],
              [
                320000,
                600000
              ],
              [
                320000,
                605000
              ],
              [
                320000,
                610000
              ],
              [
                320000,
                615000
              ],
              [
                325000,
                615000
              ],
              [
                325000,
                620000
              ],
              [
                330000,
                620000
              ],
              [
                330000,
                625000
              ],
              [
                335000,
                625000
              ],
              [
                335000,
                630000
              ],
              [
                340000,
                630000
              ],
              [
                340000,
                635000
              ],
              [
                340000,
                640000
              ],
              [
                340000,
                645000
              ],
              [
                340000,
                650000
              ],
              [
                345000,
                650000
              ],
              [
                350000,
                650000
              ],
              [
                355000,
                650000
              ],
              [
                360000,
                650000
              ],
              [
                365000,
                650000
              ],
              [
                370000,
                650000
              ],
              [
                375000,
                650000
              ],
              [
                380000,
                650000
              ],
              [
                380000,
                645000
              ],
              [
                385000,
                645000
              ],
              [
                390000,
                645000
              ],
              [
                390000,
                640000
              ],
              [
                395000,
                640000
              ],
              [
                395000,
                635000
              ],
              [
                395000,
                630000
              ],
              [
                395000,
                625000
              ],
              [
                400000,
                625000
              ],
              [
                400000,
                620000
              ],
              [
                400000,
                615000
              ],
              [
                400000,
                610000
              ],
              [
                395000,
                610000
              ],
              [
                395000,
                605000
              ],
              [
                390000,
                605000
              ],
              [
                390000,
                600000
              ],
              [
                385000,
                600000
              ],
              [
                380000,
                600000
              ],
              [
                375000,
                600000
              ],
              [
                375000,
                595000
              ],
              [
                370000,
                595000
              ]
            ]
          ]
        ]
      },
      "type": "Feature",
      "properties": {
        "code": "roxb",
        "county": "Roxburghshire"
      }
    }
  ],
  "type": "FeatureCollection"
};

const DECADES_WEST = {
  '7.056': [1860,1890,1910,1920,1930,1940,1950,1960,1980,1990],
  '5.3': [1860,1890,1910,1920,1930,1940,1950,1960,1980,1990],
  '3.5': [1860,1890,1910,1920,1930,1940,1950,1960,1980,1990],
  '2.65': [1860,1890,1910,1920,1930,1940,1950,1960,1980,1990],
  '1.76': [1860,1890,1910,1930,1950],
  '0.88': [1860,1890,1910,1930,1950],
  '0.635': [1860,1890,1910,1930,1950],
  '0.441': [1860,1890,1910,1930,1950,1960],
  '0.352': [1950,1960,1980],
  '0.265': [1950,1960,1980],
  '0.176': [1850,1890],
  '0.088': [1850,1890],
};

const DECADES_EAST = {
  '7.056': [1870,1880,1890,1920,1930,1950,1960,1970,1990],
  '5.3': [1870,1880,1890,1920,1930,1950,1960,1970,1990],
  '3.5': [1870,1880,1890,1920,1930,1950,1960,1970,1990],
  '2.65': [1870,1880,1890,1920,1930,1950,1960,1970,1990],
  '1.76': [1870,1890,1910,1950,1960],
  '0.88': [1870,1890,1910,1950,1960],
  '0.635': [1870,1890,1910,1950,1960],
  '0.441': [1870,1890,1910,1950,1960],
  '0.352': [1870,1890,1910,1920,1950,1960],
  '0.265': [1870,1890,1910,1920,1950,1960],
  '0.176': [],
  '0.088': [],
};

const IMAGE_FILES = {
  'png':  'ancient_roam.png',
  'jpeg': 'ancient_roam.jpeg'
};

let getDecades = (req, res) => {
  if (req.query.resolution <= 7.056) {
    if (DECADES_EAST['' + req.query.resolution] === undefined) {
        res.status(400)
        res.json([]);
    }
    else if (req.query.minx < 469000) {
      res.json(DECADES_WEST['' + req.query.resolution]);
    } else {
      res.json(DECADES_EAST['' + req.query.resolution]);
    }
  } else {
    console.log("Resolution's value greater than 7.056 will trigger an error");
    res.status(400);
    res.json();
  }
};

let getOverlappingCounties = (req, res) => {
  console.log('Getting Overlapping Counties');
  res.json(OVERLAPPING_COUNTIES);
};

let saveImageAs = (req, res) => {
  const request = req.query;
  const type = request.format.split('/')[1];

  try {
    res.send(IMAGE_FILES[type]);
  } catch (e) {
    console.error('Unknown format: ', type);
  }
};

let saveImageDownload = (req, res) => {
  const request = req.query;
  const filename = __dirname + '/files/' + request.id;
  const file = fs.readFileSync(filename, 'binary');

  res.setHeader('Content-disposition',
    'attachment; filename=ancientroam.' + type);
  res.setHeader('Content-type', request.format);
  res.setHeader('Content-Length', file.length);

  res.write(file, 'binary');
  res.end();
};

module.exports = {
  getDecades,
  getOverlappingCounties,
  saveImageAs,
  saveImageDownload
};
